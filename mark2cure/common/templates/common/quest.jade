extends base

- load widget_tweaks
- load brabeion_tags

block header
  - with headerMessage=task.name
    include includes/header-quest

block content
  .container-fluid
    div(style="background: #f5f5f5;").row
      .col-xs-6.col-xs-offset-1

        // Document header Information
        // 1) List of document Icons
        // 2) Ongoing score (live)
        // 3) Current Level (not live)
        .row.quest-guide
          - for doc in completed_docs
            div.doc-item-col.col-xs-2.col-sm-1.text-center
              h4 &#8226;
          - for doc in documents
            div(data-doc="{{doc.pk}}").doc-item-col.col-xs-2.col-sm-1.text-center
              h4 &#8226;
      .col-xs-2
        h4.pull-right Score: <span id='score'>#{user.userprofile.rating_score}</span>
      .col-xs-2
        h4 Level: #{user.userprofile.highest_level.name}

    .row
      - for doc in documents
          div(id="doc_{{doc.pk}}", data-doc_pk="{{doc.pk}}", data-pmid="{{doc.document_id}}", style="display:none;").container.document
            .paragraphs

            // Hiiden form in place to submit the document annotations
            div(style="display:none;")
              form(method="post", action="/document/{{task.pk}}/{{doc.pk}}/submit/")
                - csrf_token
                input(type="hidden", name="task_type", value="concept-recognition")



  .container.head-space
    .row
      .col-xs-3
        ul.list-unstyled
          li(style='background-color: #d1f3ff;')
            a(href='{% url "instructions:disease-marking" %}', target='_blank')
              p.text-center Disease Concept
          li(style='background-color: #d1ffdd;')
            a(href='{% url "instructions:gene-marking" %}', target='_blank')
              p.text-center Genes Concept
          li(style='background-color: #ffd1dc;')
            a(href='{% url "instructions:treatment-marking" %}', target='_blank')
              p.text-center Treatments Concept

      // Init all submission events
      // 1) Submit the document
      // 2) Go to next document (after review)
      // 3) Submit the Quest as complete
      div(style="padding-top:2px;").col-xs-4.col-xs-offset-1
        div(id="quest-submit").button.btn.btn-default.btn-block.done Submit

  // Hidden form to submit the quest
  div(style="display: none;").container
    form(id="quest-complete", method="post", action="/quest/{{task.pk}}/")
      - csrf_token
      input(type="hidden", name="task_type", value="concept-recognition")



block post-footer
  script(src='#{STATIC_URL}js/quest-app.js')
  script.
    var task_id = "{{ task.pk }}";
    var self_data;

    $('.document').each(function(iter_idx) {
      var $el = $(this),
          doc_pk = $(this).data('doc_pk'),
          pmid = $(this).data('pmid'),
          $paragraphs = $('.paragraphs', $el);

      YPet.addInitializer(function(options) {
      $.getJSON('/document/'+ pmid +'.json', function( data ) {
        self_data = data;
        var passages = data.collection.document.passage;
        var regions = {};
        _.each(passages, function(passage, passage_idx) {
          var p_body = '<div id="'+ passage.infon[2]['#text'] +'" class="paragraph-box head-space"><p class="paragraph"></p></div></div>';
          $paragraphs.append(p_body);
          regions[''+passage_idx] = '#'+passage.infon[2]['#text'];
        });
        YPet.addRegions(regions);

        _.each(passages, function(passage, passage_idx) {
          var p = new Paragraph({'text': passage.text});
          YPet[''+passage_idx].show( new WordCollectionView({
            collection: p.get('words'),
            passage_json: passage,
            bioc_json: data
          }) );
        });

        });
      });
      YPet.start();

      if(iter_idx == 0) { activate_tabs(doc_pk); }

    });

