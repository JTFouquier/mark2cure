extends base

- load widget_tweaks
- load brabeion_tags

block header
  - with headerMessage='Community Dashboard'
    include includes/header

block content
  .container
    .row
      .col-md-10.col-md-offset-1
        #dashboard.row.head-space
          .col-xs-12.text-center
            h2.quest Loading...

  include document/includes/welcome-modal

block post-footer
    #fb-root
    - if welcome
      script.
        $('#dashboardWelcomeModal').modal('show');

    script.
      var draw_dashbaord = function(data) {
        $('#dashboard').html('');
        var canvas = d3.select('#dashboard');

        var available_quests = _.filter(data, function(item) { return item.enabled && !item.completed });
        var completion_size = _.map(available_quests, function(item) { return item.completions; });

        var completion_scale = d3.scale.linear()
          .domain([_.min(completion_size), _.max(completion_size)])
          .range(['#00CCFF', '#E64C66']);

        var template = _.template("
        <div class='row'>
          <div class='col-xs-12 text-center'>

            <% if(d.enabled && !d.completed) { %>
              <p style='font-size: 32px;'><strong><a href='/quest/<%- d.id %>/'><%- d.id %></a></strong></p>
            <% } %>

            <% if(d.enabled && d.completed) { %>
              <span class='glyphicon glyphicon-ok'></span>
            <% } %>

            <% if(!d.enabled) { %>
              <span class='glyphicon glyphicon-ban-circle muted'></span>
            <% } %>

          </div>
        </div>

        <% if(d.enabled) { %>
          <div class='row'>
            <div class='col-xs-12'>
              <div class='progress'>
                <div class='progress-bar' role='progressbar' aria-valuenow='<%- progress %>' aria-valuemin='0' aria-valuemax='100' style='width: <%- progress %>%;'>
                  <span><%- d.submissions %> Documents</span>
                </div>
              </div>
            </div>
          </div>
        <% } %>
          ");

        var attrs = {
          'class': 'quest col-sm-3',
        };
        var styles = {
        };
        var quest = canvas.selectAll('.quest').remove();
        var quest = canvas.selectAll('.quest').data(data);

        quest.enter().append('div')
          .attr(attrs)
          .style(styles)
          .html(function(d, i) {
            return template({
              'd': d,
              'progress': (d.submissions/d.completions)*100,
              'completions_scale': completion_scale(d.completions),
            });
          });
        quest.transition().attr(attrs);
        quest.exit().remove();
      };

      var ajax_settings = {
        'type': 'GET',
        'url': '/quest/api/read/',
        'success': function(data) { draw_dashbaord(data); }
      };

      /* setInterval(function () { $.ajax(ajax_settings); }, 3000); */
      $.ajax(ajax_settings);
