extends base

- load widget_tweaks
- load brabeion_tags

block header
  - with headerMessage='Community Dashboard'
    include includes/header

block content
  .container
    .row
      .col-md-10.col-md-offset-1
        #dashboard.row.head-space
          .col-xs-12.text-center
            h2.quest Loading...

  .container.head-space
    .row
      .col-md-12.line
      .col-md-12
        p.line-text.text-center Details
      .col-md-10.col-md-offset-1
        .row
          .col-md-10.col-md-offset-1
            p Mark2Cure aims to speed up progress in biomedical research by applying the collective intelligence of users just like you! By "marking" docus, you help to annotate biomedical research literature, allowing researchers to gather information...
        .row
          .col-md-10.col-md-offset-1
            h3 I'm here because:
            p #{profile.motivation}

  .container.head-space
    .row
      .col-md-12.line
      .col-md-12
        p.line-text.text-center News
      .col-md-10.col-md-offset-1
        - for post in posts
          .row
            .col-md-12
              h4 #{post.title}
              p #{post.excerpt}


block post-footer
    #fb-root
    script.
      var draw_dashbaord = function(data) {
        var canvas = d3.select('#dashboard');

        var max_doc_size = _.max(_.map(data, function(item) { return item.documents.length; }));

        var document_pool = d3.scale.linear()
          .domain([0, max_doc_size])
          .range([0, 100]);

        var determine_status_icon = function(d) {
          if(!d.enabled) { return 'ban-circle'; }
          return 'ok-circle';
        };

        var template = _.template("
        <div class='row'>
          <div class='col-xs-12 text-center'>
            <% if(d.enabled) { %>
              <p><strong><a href='/quest/<%- d.id %>/'><%- d.name %></a></strong></p>
            <% } else { %>
              <p class='muted'><%- d.name %></p>
            <% } %>
          </div>
        </div>

        <div class='row'>
          <div class='col-xs-12 text-center'>
            <span class='glyphicon glyphicon-<%- status %>'></span>
          </div>
        </div>

        <% if(d.enabled) { %>
        <div class='row'>
          <div class='col-xs-12'>
            <div class='progress'>
              <div class='progress-bar' role='progressbar' aria-valuenow='<%- document_pool %>' aria-valuemin='0' aria-valuemax='100' style='width: <%- document_pool %>%;'>
                <span><%- d.documents.length %> Documents</span>
              </div>
            </div>
          </div>
        </div>
        <% } %>
          ");

        var attrs = {
          'class': 'quest col-sm-3',
        };
        var styles = {
        };
        var quest = canvas.selectAll('.quest').remove();
        var quest = canvas.selectAll('.quest').data(data);


        quest.enter().append('div')
          .attr(attrs)
          .style(styles)
          .html(function(d) {
            return template({
              'd': d,
              'document_pool': document_pool(d.documents.length),
              'status': determine_status_icon(d)
            });
          });
        quest.transition().attr(attrs);
        quest.exit().remove();

      };

      $.ajax({
        'type': 'GET',
        'url': '/quest/api/read/',
        'success': function(data) {
          draw_dashbaord(data);
        }
      });
